name: Backup

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:  # Allow manual trigger

env:
  BACKUP_BUCKET: ${{ secrets.BACKUP_BUCKET }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  backup:
    name: Backup Database
    runs-on: ubuntu-latest
    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install

      - name: Backup database
        run: |
          PGPASSWORD=${DATABASE_URL#*:*@*:*} \
          pg_dump -h ${DATABASE_URL#*@} \
                 -U ${DATABASE_URL%%:*} \
                 ${DATABASE_URL##*/} \
          | gzip > backup-${{ steps.date.outputs.date }}.sql.gz

      - name: Upload to S3
        run: |
          aws s3 cp \
            backup-${{ steps.date.outputs.date }}.sql.gz \
            s3://$BACKUP_BUCKET/daily/backup-${{ steps.date.outputs.date }}.sql.gz

      - name: Cleanup old backups
        run: |
          # Keep last 30 daily backups
          aws s3 ls s3://$BACKUP_BUCKET/daily/ \
            | sort -r \
            | tail -n +31 \
            | awk '{print $4}' \
            | xargs -I {} aws s3 rm s3://$BACKUP_BUCKET/daily/{}
