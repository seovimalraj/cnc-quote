{
  "dashboard": {
    "title": "Step 19: E2E Pricing Observability",
    "tags": ["observability", "pricing", "tracing"],
    "timezone": "browser",
    "schemaVersion": 38,
    "version": 1,
    "refresh": "30s",
    "panels": [
      {
        "id": 1,
        "title": "API Request Rate & Error Rate",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
        "targets": [
          {
            "expr": "sum(rate(api_http_requests_total[5m])) by (status)",
            "legendFormat": "{{status}}",
            "refId": "A"
          },
          {
            "expr": "sum(rate(api_http_requests_total{status=~\"5..\"}[5m])) / sum(rate(api_http_requests_total[5m]))",
            "legendFormat": "Error Rate",
            "refId": "B"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "reqps",
            "color": { "mode": "palette-classic" }
          },
          "overrides": [
            {
              "matcher": { "id": "byName", "options": "Error Rate" },
              "properties": [
                { "id": "unit", "value": "percentunit" },
                { "id": "custom.axisPlacement", "value": "right" }
              ]
            }
          ]
        }
      },
      {
        "id": 2,
        "title": "API p95 Latency by Route",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(api_http_request_duration_ms_bucket[5m])) by (le, route))",
            "legendFormat": "{{route}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "ms",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 500 },
                { "color": "red", "value": 1000 }
              ]
            }
          }
        }
      },
      {
        "id": 3,
        "title": "E2E Pricing Latency (p50, p95, p99)",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
        "targets": [
          {
            "expr": "histogram_quantile(0.50, sum(rate(pricing_end_to_end_latency_ms_bucket[5m])) by (le, process))",
            "legendFormat": "p50 - {{process}}",
            "refId": "A"
          },
          {
            "expr": "histogram_quantile(0.95, sum(rate(pricing_end_to_end_latency_ms_bucket[5m])) by (le, process))",
            "legendFormat": "p95 - {{process}}",
            "refId": "B"
          },
          {
            "expr": "histogram_quantile(0.99, sum(rate(pricing_end_to_end_latency_ms_bucket[5m])) by (le, process))",
            "legendFormat": "p99 - {{process}}",
            "refId": "C"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "ms",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 1500 },
                { "color": "red", "value": 2000 }
              ]
            }
          }
        }
      },
      {
        "id": 4,
        "title": "Worker Queue Depth",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
        "targets": [
          {
            "expr": "redis_queue_depth",
            "legendFormat": "{{queue}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 100 },
                { "color": "red", "value": 500 }
              ]
            }
          }
        }
      },
      {
        "id": 5,
        "title": "Worker Job Duration p95",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(worker_job_duration_ms_bucket[5m])) by (le, queue))",
            "legendFormat": "{{queue}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "ms",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 20000 },
                { "color": "red", "value": 30000 }
              ]
            }
          }
        }
      },
      {
        "id": 6,
        "title": "Worker Job Processing Rate",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
        "targets": [
          {
            "expr": "sum(rate(worker_jobs_processed_total{status=\"completed\"}[5m])) by (queue)",
            "legendFormat": "{{queue}} - completed",
            "refId": "A"
          },
          {
            "expr": "sum(rate(worker_jobs_processed_total{status=\"failed\"}[5m])) by (queue)",
            "legendFormat": "{{queue}} - failed",
            "refId": "B"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "ops",
            "color": { "mode": "palette-classic" }
          }
        }
      },
      {
        "id": 7,
        "title": "CAD Extract Duration p95",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 },
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(cad_extract_duration_ms_bucket[5m])) by (le))",
            "legendFormat": "p95",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "ms",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 15000 },
                { "color": "red", "value": 20000 }
              ]
            }
          }
        }
      },
      {
        "id": 8,
        "title": "CAD Request Rate & Error Rate",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
        "targets": [
          {
            "expr": "sum(rate(cad_extract_requests_total[5m])) by (status)",
            "legendFormat": "{{status}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "reqps",
            "color": { "mode": "palette-classic" }
          }
        }
      },
      {
        "id": 9,
        "title": "Top Error Logs with Trace IDs",
        "type": "logs",
        "gridPos": { "h": 8, "w": 24, "x": 0, "y": 32 },
        "targets": [
          {
            "expr": "{level=\"error\"} |= \"\" | json | line_format \"{{.ts}} [{{.traceId}}] {{.msg}} - {{.error}}\"",
            "refId": "A"
          }
        ],
        "options": {
          "showTime": true,
          "wrapLogMessage": true,
          "enableLogDetails": true
        }
      },
      {
        "id": 10,
        "title": "Service Map Topology",
        "type": "nodeGraph",
        "gridPos": { "h": 10, "w": 24, "x": 0, "y": 40 },
        "targets": [
          {
            "expr": "sum(rate(traces_service_graph_request_total[5m])) by (client, server)",
            "refId": "A"
          }
        ],
        "options": {
          "showLabels": true
        }
      },
      {
        "id": 11,
        "title": "Active Alerts",
        "type": "alertlist",
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 50 },
        "options": {
          "showOptions": "current",
          "maxItems": 20,
          "sortOrder": 3
        }
      },
      {
        "id": 12,
        "title": "SLO Burn Rate (7d)",
        "type": "stat",
        "gridPos": { "h": 8, "w": 12, "x": 12, "y": 50 },
        "targets": [
          {
            "expr": "1 - (histogram_quantile(0.95, sum(rate(pricing_end_to_end_latency_ms_bucket[7d])) by (le)) / 2000)",
            "legendFormat": "Pricing Latency SLO",
            "refId": "A"
          },
          {
            "expr": "1 - (sum(rate(api_http_requests_total{status=~\"5..\"}[7d])) / sum(rate(api_http_requests_total[7d])))",
            "legendFormat": "API Error Rate SLO",
            "refId": "B"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percentunit",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "red", "value": 0 },
                { "color": "yellow", "value": 0.95 },
                { "color": "green", "value": 0.99 }
              ]
            }
          }
        },
        "options": {
          "colorMode": "background",
          "graphMode": "area",
          "justifyMode": "auto",
          "textMode": "value_and_name"
        }
      }
    ]
  }
}
