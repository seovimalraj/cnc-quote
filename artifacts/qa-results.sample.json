{
  "timestamp": "2025-09-09T20:30:00Z",
  "version": "prepublish-qa-runner-v1.0",
  "environment": "development",
  "preflight": [
    {
      "name": "API reachable",
      "passed": true,
      "details": {
        "status": 200,
        "url": "http://localhost:3001/health",
        "response_time_ms": 45
      }
    },
    {
      "name": "CAD service reachable",
      "passed": true,
      "details": {
        "status": 200,
        "url": "http://localhost:8000/health",
        "response_time_ms": 23
      }
    },
    {
      "name": "Storage signed URL roundtrip",
      "passed": true,
      "details": "Signed URL generation and upload successful"
    },
    {
      "name": "Database migrations applied",
      "passed": true,
      "details": "All migrations up to date"
    }
  ],
  "smoke": [
    {
      "suite_id": "INSTANT_QUOTE_E2E",
      "step": "Upload STEP file at /instant-quote",
      "passed": true,
      "traces": [
        "File dropzone located",
        "STEP file uploaded successfully",
        "File validation passed",
        "Summary skeleton displayed"
      ]
    },
    {
      "suite_id": "INSTANT_QUOTE_E2E",
      "step": "Lead gate modal validation",
      "passed": false,
      "error": "Business email validation not enforcing domain restrictions",
      "traces": [
        "Modal opened successfully",
        "Phone validation working",
        "Email validation too permissive"
      ]
    },
    {
      "suite_id": "DFM_ANALYSIS_E2E",
      "step": "20 checks present with states and highlights",
      "passed": true,
      "traces": [
        "DFM analysis completed",
        "20 checks returned",
        "All checks have pass/warning/blocker states",
        "Highlights present for failed checks"
      ]
    }
  ],
  "functional": [
    {
      "name": "RLS policies",
      "passed": true,
      "logs": "All RLS policies validated successfully"
    },
    {
      "name": "Pricing engine",
      "passed": true,
      "logs": "Pricing calculations within expected ranges"
    },
    {
      "name": "CAD pipeline",
      "passed": true,
      "logs": "CAD service responding, analysis queue processing"
    },
    {
      "name": "Payment flow",
      "passed": false,
      "logs": "Stripe webhook signature validation failing"
    }
  ],
  "ui_audit": {
    "lighthouse": {
      "/instant-quote": {
        "performance": 85,
        "accessibility": 98,
        "best_practices": 92,
        "seo": 88
      },
      "/dfm-analysis": {
        "performance": 78,
        "accessibility": 96,
        "best_practices": 90,
        "seo": 85
      }
    },
    "axe": {
      "/instant-quote": [
        {
          "code": "A11Y_CONTRAST",
          "severity": "serious",
          "nodes": 3,
          "description": "Text contrast ratio below 4.5:1"
        }
      ],
      "/dfm-analysis": []
    }
  },
  "security": [
    {
      "name": "CORS/CSP/HSTS headers",
      "passed": true,
      "details": "All security headers present and correctly configured"
    },
    {
      "name": "Signed file URLs only",
      "passed": true,
      "details": "Public file access properly blocked"
    },
    {
      "name": "Lead rate limit",
      "passed": true,
      "details": "Rate limiting working correctly (429 responses observed)"
    }
  ],
  "problems_found": [
    {
      "id": "PRB-001",
      "suite": "INSTANT_QUOTE_E2E",
      "fail_code": "IQ_LEAD_VALIDATION_BROKEN",
      "route": "/instant-quote",
      "severity": "major",
      "summary": "Lead modal validation not enforcing business email domains",
      "evidence": [
        "gmail.com and yahoo.com emails accepted",
        "Domain blocklist not implemented"
      ],
      "suggested_fix": "ENABLE_DOMAIN_BLOCKLIST",
      "owner": "web",
      "status": "open"
    },
    {
      "id": "PRB-002",
      "suite": "functional",
      "fail_code": "PAYMENT_FAIL",
      "severity": "blocker",
      "summary": "Stripe webhook signature validation failing",
      "evidence": [
        "Webhook endpoint returning 400",
        "Signature verification error in logs"
      ],
      "suggested_fix": "VERIFY_STRIPE_KEYS",
      "owner": "payments",
      "status": "open"
    },
    {
      "id": "PRB-003",
      "suite": "ui_audit",
      "fail_code": "A11Y_CONTRAST",
      "route": "/instant-quote",
      "severity": "major",
      "summary": "Text contrast ratio issues on instant quote page",
      "evidence": [
        "3 elements with contrast ratio < 4.5:1",
        "Primary button text on light background"
      ],
      "suggested_fix": "A11Y_CONTRAST",
      "owner": "web",
      "status": "open"
    }
  ],
  "autofix_applied": [
    {
      "id": "FIX-001",
      "recipe": "ENABLE_DOMAIN_BLOCKLIST",
      "result": "patched",
      "logs": "Domain validation added to LeadModal component"
    },
    {
      "id": "FIX-002",
      "recipe": "VERIFY_STRIPE_KEYS",
      "result": "patched",
      "logs": "Stripe webhook secret updated in environment"
    }
  ],
  "ui_issues": [
    {
      "code": "A11Y_CONTRAST",
      "route": "/instant-quote",
      "nodes": 3,
      "severity": "serious",
      "fix": "Update --color-primary to #1e3a8a and --color-base to #111827"
    },
    {
      "code": "TOUCH_TARGET_SMALL",
      "route": "/dfm-analysis",
      "nodes": 2,
      "severity": "moderate",
      "fix": "Increase button padding to minimum 44px touch target"
    }
  ],
  "publish_gate": {
    "eligible": false,
    "reasons": [
      "IQ_LEAD_VALIDATION_BROKEN in INSTANT_QUOTE_E2E",
      "PAYMENT_FAIL in functional tests",
      "A11Y_CONTRAST violations in UI audit",
      "2 blocker/critical problems found"
    ]
  },
  "execution_time_ms": 45230,
  "tests_run": 24,
  "tests_passed": 19,
  "tests_failed": 5
}
