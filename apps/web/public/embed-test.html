<!DOCTYPE html>
<html>
<head>
  <title>Widget Embed Test</title>
  <style>
    #widget-container {
      width: 100%;
      max-width: 800px;
      height: 600px;
      margin: 20px auto;
      border: 1px solid #ccc;
    }
    #log-container {
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      padding: 10px;
      background: #f5f5f5;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-y: auto;
      max-height: 300px;
    }
    .error { color: #dc3545; }
    .success { color: #198754; }
    .info { color: #0d6efd; }
  </style>
</head>
<body>
  <div id="widget-container"></div>
  <div id="log-container"></div>

  <script>
    // Configuration
    const config = {
      widgetUrl: new URL(document.location.search).searchParams.get('widget_url') || 'http://localhost:3000/widget',
      mockOrigin: new URL(document.location.search).searchParams.get('mock_origin') || document.location.origin
    };

    // Logging setup
    const logs = [];
    function log(type, message) {
      const entry = `[${new Date().toISOString()}] [${type}] ${message}`;
      logs.push(entry);
      
      const logContainer = document.getElementById('log-container');
      const line = document.createElement('div');
      line.className = type.toLowerCase();
      line.textContent = entry;
      logContainer.appendChild(line);
      
      // Keep only last 100 logs
      if (logContainer.children.length > 100) {
        logContainer.removeChild(logContainer.firstChild);
      }

      // Also log to console for external capture
      console.log(entry);
    }

    // Error handler
    window.onerror = function(msg, url, line, col, error) {
      log('ERROR', `${msg} (${url}:${line}:${col})`);
      return false;
    };

    // Load widget
    function loadWidget() {
      log('INFO', `Loading widget from ${config.widgetUrl}`);
      log('INFO', `Using mock origin: ${config.mockOrigin}`);

      const iframe = document.createElement('iframe');
      iframe.src = `${config.widgetUrl}?debug=1`;
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = 'none';
      
      document.getElementById('widget-container').appendChild(iframe);

      // Track load status
      iframe.onload = () => {
        log('SUCCESS', 'Widget iframe loaded');
        testPostMessage();
      };

      iframe.onerror = () => {
        log('ERROR', 'Widget iframe failed to load');
      };
    }

    // Test postMessage communication
    function testPostMessage() {
      const testData = {
        type: 'INIT',
        payload: {
          part: {
            process: 'CNC',
            material: 'AL6061',
            quantity: 10
          }
        }
      };

      log('INFO', 'Testing postMessage communication...');
      
      try {
        // Listen for messages
        window.addEventListener('message', (event) => {
          try {
            if (event.data?.type === 'price:updated') {
              log('SUCCESS', `Received price update: ${JSON.stringify(event.data.payload)}`);
            } else {
              log('INFO', `Received message: ${JSON.stringify(event.data)}`);
            }
          } catch (e) {
            log('ERROR', `Failed to parse message: ${e.message}`);
          }
        });

        // Send test message
        const iframe = document.querySelector('iframe');
        iframe.contentWindow.postMessage(testData, config.widgetUrl);
        log('INFO', `Sent test message: ${JSON.stringify(testData)}`);
      } catch (e) {
        log('ERROR', `PostMessage failed: ${e.message}`);
      }
    }

    // Export logs for external collection
    window.getTestLogs = () => logs.join('\n');

    // Start test
    document.addEventListener('DOMContentLoaded', loadWidget);
  </script>
</body>
</html>
